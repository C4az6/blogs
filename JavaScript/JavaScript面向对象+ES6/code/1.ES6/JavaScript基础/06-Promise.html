<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
</head>

<body>
  <script>
    /* 
      基本概念：
        Promise：是ES6中新增的异步编程解决方案，体现在代码中他是一个对象，
        可以通过Promise 构造函数来实例化。
      
      new Promise(cb) ===> 实例的基本使用 Pending Resolved Rejected

      两个原型方法：
        Promise.prototype.then()
        Promise.prototype.catch()

      两个常用的静态方法：
        Promise.all()
        Promise.resolve()

      new Promise(cb);
      Pending(进行中) ===> Resolved(已完成)
      Pending(进行中) ===> Rejected(已失败)
     */

    const imgs = [
      'https://images.unsplash.com/photo-1593642634367-d91a135587b5?ixlib=rb-1.2.1&ixid=eyJhcHBfaWQiOjEyMDd9&auto=format&fit=crop&w=1350&q=80',
      'https://images.unsplash.com/photo-1605719882474-71f5ebe2ad55?ixlib=rb-1.2.1&ixid=eyJhcHBfaWQiOjEyMDd9&auto=format&fit=crop&w=700&q=80',
      'https://images.unsplash.com/photo-1605721930279-d3bbf667c241?ixlib=rb-1.2.1&ixid=eyJhcHBfaWQiOjEyMDd9&auto=format&fit=crop&w=634&q=80',
      'https://images.unsplash.com/photo-1593642634443-44adaa06623a?ixlib=rb-1.2.1&ixid=eyJhcHBfaWQiOjEyMDd9&auto=format&fit=crop&w=1225&q=80'
      // ''
    ];

    //  const p = new Promise(function(resolve, reject) {
    //    const img = new Image(300, 300);
    //    img.src = imgs[0];
    //    img.onload = function() {    // 当图像装载完毕时调用的事件
    //      resolve(this);
    //    }
    //    img.onerror = function(err) {    // 在装载图像的过程中发生错误时调用的事件
    //      reject(err)
    //    }
    //  })
    //  console.log(123);
    //  p.then(function(res){
    //   console.log("图片加载完毕!!!");
    //   document.body.appendChild(res);
    //  })
    //  console.log(456)
    //  // 打印顺序：123 => 456 => 图片加载完毕，由此可以看出promise的代码是异步执行的，不会阻塞后面代码的执行

    // ----------------------------------------------------------------------------------------------------

    // 将加载图片的代码封装为一个函数
    function loadImg(url) {
      const p = new Promise(function (resolve, reject) {
        const img = new Image(300, 300);
        // img.src = '';
        img.src = url;
        img.onload = function () {
          resolve(this);
        }
        img.onerror = function (error) {
          // reject(new Error('图片加载失败!!!'));    // 不推荐使用new Error方式抛出异常
          reject(error)
        };
      });
      return p;
    }

    // loadImg(imgs[1]).then(function (res) { // resolve成功之后的回调函数
    //   document.body.appendChild(res);
    // }).catch(function (error) { // reject失败之后的回调函数
    //   console.log(error);
    // })

    // ----------------------------------------------------------------------------------------------------
    /* 
      Promise.all 可以将多个Promise实例包装成一个新的Promise实例

      - 当所有Promise实例的状态都变成resolved，Promise.all的状态才会变成resolved，此时返回值组成一个数组，传递给then中的resolve函数。

      - 只要其中有一个被rejected，Promise.all的状态就变成rejected，此时第一个被reject的实例的返回值，会传递给p的回调函数。
     */

    // const allDone = Promise.all([loadImg(imgs[0]), loadImg(imgs[1]), loadImg(imgs[2]), loadImg(imgs[3])])
    // allDone.then(function (res) {
    //   console.log(res);
    //   res.forEach(function (item) {
    //     document.body.appendChild(item);
    //   })
    // }).catch(error => {
    //   console.log(error);   // 有一张图片加载异常就会出现错误
    // })


    // ----------------------------------------------------------------------------------------------------
    /* 
    参数是Promise实例，将不做任何修改、原封不动地返回这个实例。
     */
    // Promise.resolve(loadImg(imgs[1])).then(function(img){document.body.appendChild(img)});

    // 将对象转为Promise对象，然后就立即执行thenable对象的then方法。
    Promise.resolve({
        then(resolve, reject) {
          const img = new Image();
          img.src = imgs[2];
          img.onload = function () {
            resolve(this)
          }
        }
      })
      .then(function (res) {
        document.body.appendChild(res);
      })

    Promise.resolve('i am a string').then(function (str) {
      console.log(str);
    })
  </script>
</body>

</html>